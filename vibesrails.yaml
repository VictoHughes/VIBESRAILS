# vibesrails - Scale up your vibe coding safely
# Single source of truth for security & quality patterns
#
# Usage:
#   vibesrails --show     # voir patterns
#   vibesrails --all      # scanner tout
#   vibesrails            # scanner staged (pre-commit)

version: "1.0"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ SECURITY - Bloque le commit
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
blocking:
  - id: hardcoded_secret
    name: "Hardcoded Secret"
    regex: "(api_key|password|secret|token|pwd|passwd)\\s*=\\s*[\"'][^\"']{4,}"
    flags: "i"
    message: "Secret hardcode - utiliser variables d'environnement"

  - id: sql_injection
    name: "SQL Injection"
    regex: "\\.execute\\s*\\([^)]*f[\"']"
    message: "SQL injection - utiliser requetes parametrees"

  - id: command_injection
    name: "Command Injection"
    regex: "(os\\.system|subprocess\\.call|subprocess\\.run|eval)\\s*\\([^)]*f[\"']"
    message: "Command injection - sanitizer les inputs ou utiliser des alternatives safe"

  - id: shell_injection
    name: "Shell Injection"
    regex: "shell\\s*=\\s*True"
    message: "shell=True dangereux - utiliser subprocess avec liste"

  - id: unsafe_yaml
    name: "Unsafe YAML"
    regex: "yaml\\.load\\s*\\("
    exclude_regex: "Loader\\s*="
    message: "Utiliser yaml.safe_load()"

  - id: unsafe_numpy
    name: "Unsafe NumPy"
    regex: "allow_pickle\\s*=\\s*True"
    message: "Permet execution de code arbitraire"

  - id: debug_mode_prod
    name: "Debug Mode in Production"
    regex: "DEBUG\\s*=\\s*True"
    flags: "i"
    message: "Debug mode active - mettre DEBUG=False en production"
    scope: ["**/settings.py", "**/config.py"]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš ï¸ WARNINGS - Signale mais autorise
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
warning:
  - id: star_import
    name: "Star Import"
    regex: "from\\s+\\S+\\s+import\\s+\\*"
    message: "Eviter star imports"
    skip_in_tests: true

  - id: none_comparison
    name: "None Comparison"
    regex: "==\\s*None"
    message: "Utiliser 'is None'"
    skip_in_tests: true

  - id: print_statement
    name: "Print Statement"
    regex: "^\\s*print\\("
    message: "Utiliser logging au lieu de print"
    skip_in_tests: true

  - id: bare_except
    name: "Bare Except"
    regex: "except:\\s*$"
    message: "Attraper exceptions specifiques"
    skip_in_tests: true

  - id: todo_comment
    name: "TODO Comment"
    regex: "#\\s*TODO"
    flags: "i"
    message: "TODO trouve - creer une tache"
    skip_in_tests: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› BUGS - Patterns causant des bugs silencieux
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bugs:
  - id: mutable_default
    name: "Mutable Default (B006)"
    regex: "def \\w+\\([^)]*=\\s*\\[\\]|def \\w+\\([^)]*=\\s*\\{\\}"
    message: "Mutable default partage entre appels"
    level: "BLOCK"

  - id: assert_in_prod
    name: "Assert in Production"
    regex: "^\\s*assert\\s+(?!.*#.*test)"
    message: "assert ignore avec python -O"
    level: "WARN"
    skip_in_tests: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ—ï¸ ARCHITECTURE - DIP & import restrictions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
architecture:
  - id: dip_domain_infra
    name: "DIP Violation (Domain â†’ Infrastructure)"
    regex: "from backend\\.infrastructure"
    scope: ["backend/domain/**/*.py"]
    message: "Domain ne doit pas importer Infrastructure (Dependency Inversion Principle)"
    level: "BLOCK"

  - id: dip_domain_application
    name: "DIP Violation (Domain â†’ Application)"
    regex: "from backend\\.application"
    scope: ["backend/domain/**/*.py"]
    message: "Domain ne doit pas importer Application (Dependency Inversion Principle)"
    level: "BLOCK"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ MAINTENABILITE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
maintainability:
  - id: print_debug
    name: "Print Debug"
    regex: "^\\s*print\\(.*debug|^\\s*print\\(f?[\"']\\s*(DEBUG|TODO|FIXME)"
    message: "Print oublie - utiliser logging"
    level: "WARN"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… EXCEPTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
exceptions:
  test_files:
    patterns:
      - "test_*.py"
      - "*_test.py"
      - "tests/**/*.py"
    allowed:
      - "hardcoded_secret"
      - "sql_injection"
      - "command_injection"
      - "shell_injection"
      - "mutable_default"
    reason: "Tests peuvent mocker patterns dangereux"

  config_files:
    patterns:
      - "**/settings.py"
      - "**/config.py"
    allowed:
      - "star_import"
    reason: "Config files may use star imports"

# Complexity (enforced by scanner)
complexity:
  max_file_lines: 300    # WARN if file exceeds this (test files excluded)
  max_function_lines: 50 # For future use

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¤– GUARDIAN - AI Coding Safety
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
guardian:
  enabled: true
  auto_detect: true
  warnings_as_blocking: false
  senior_mode: "auto"  # Run Senior Mode when AI session detected
  max_file_lines: 300  # PreToolUse BLOCKS writes exceeding this (split into modules)
