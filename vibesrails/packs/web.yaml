# @vibesrails/web-pack
# Web application security patterns (XSS, CSRF, etc.)
# Usage: extends: "@vibesrails/web-pack"

version: "1.0"

blocking:
  # XSS Prevention
  - id: xss_inner_html
    name: "XSS via innerHTML"
    regex: "innerHTML\\s*="
    message: "innerHTML can cause XSS - use textContent or sanitize input"

  - id: xss_doc_write
    name: "XSS via doc write"
    regex: "document\\.write\\("
    message: "Avoid document write - use DOM methods instead"

  - id: xss_template_unescaped
    name: "Unescaped Template Variable"
    regex: "\\{\\{\\s*\\w+\\s*\\|\\s*safe\\s*\\}\\}|\\{%\\s*autoescape\\s+false"
    message: "Unescaped template output may cause XSS"

  # CSRF Prevention
  - id: csrf_exempt_view
    name: "CSRF Exemption"
    regex: "@csrf_exempt"
    message: "CSRF exemption should be carefully reviewed"

  # Headers
  - id: cors_allow_all
    name: "CORS Allow All Origins"
    regex: "Access-Control-Allow-Origin.*\\*|CORS_ALLOW_ALL_ORIGINS\\s*=\\s*True"
    message: "CORS should not allow all origins in production"

  # URL Handling
  - id: open_redirect
    name: "Open Redirect Risk"
    regex: "redirect\\([^)]*request\\.(GET|POST|args|form)\\[|HttpResponseRedirect\\([^)]*request\\."
    message: "Unvalidated redirect may allow phishing - validate destination URL"

warning:
  # Session Security
  - id: session_permanent
    name: "Permanent Session"
    regex: "session\\.permanent\\s*=\\s*True|SESSION_PERMANENT\\s*=\\s*True"
    message: "Permanent sessions increase attack window - consider timeout"

  # File Upload
  - id: file_upload_no_validation
    name: "File Upload Without Validation"
    regex: "request\\.files\\[|FileField\\(.*upload_to"
    message: "Validate file type, size, and sanitize filename"
    skip_in_tests: true

  # HTML Rendering
  - id: render_string
    name: "Render User String"
    regex: "render_template_string\\("
    message: "render_template_string with user input causes SSTI"

  # API Keys in Frontend
  - id: api_key_frontend
    name: "API Key in Frontend"
    regex: "REACT_APP_.*KEY|VUE_APP_.*KEY|NEXT_PUBLIC_.*KEY"
    message: "API keys in frontend are exposed - use backend proxy"
