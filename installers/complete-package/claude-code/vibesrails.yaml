# vibesrails - Scale up your vibe coding safely
# Single source of truth for security & quality patterns
#
# Documentation: https://github.com/VictoHughes/VIBESRAILS

version: "1.0"

# KIONOS Safety Formula
kionos:
  formula: "C(q,xÌ‚) = Î±S + Î²V + Î³R"
  threshold: 0.7

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ SECURITY - Blocks commit
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
blocking:
  - id: hardcoded_secret
    name: "Hardcoded Secret"
    regex: "(api_key|password|secret|token|pwd|passwd)\\s*=\\s*[\"'][^\"']{4,}"
    flags: "i"
    message: "Hardcoded secret detected - use environment variables"

  - id: sql_injection
    name: "SQL Injection"
    regex: "\\.execute\\s*\\([^)]*f[\"']"
    message: "SQL injection risk - use parameterized queries"

  - id: command_injection
    name: "Command Injection"
    regex: "(os\\.system|subprocess\\.call|subprocess\\.run|eval)\\s*\\([^)]*f[\"']"
    message: "Command injection risk - sanitize input or use safe alternatives"

  - id: shell_injection
    name: "Shell Injection"
    regex: "shell\\s*=\\s*True"
    message: "shell=True is dangerous - use subprocess with list args"

  - id: unsafe_yaml
    name: "Unsafe YAML"
    regex: "yaml\\.load\\s*\\("
    exclude_regex: "Loader\\s*="
    message: "Use yaml.safe_load() instead"

  - id: unsafe_numpy
    name: "Unsafe NumPy"
    regex: "allow_pickle\\s*=\\s*True"
    message: "Allows arbitrary code execution"

  - id: debug_mode_prod
    name: "Debug Mode in Production"
    regex: "DEBUG\\s*=\\s*True"
    flags: "i"
    message: "Debug mode enabled - set DEBUG=False in production"
    scope: ["**/settings.py", "**/config.py"]

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš ï¸  WARNINGS - Shows warning, doesn't block
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
warning:
  - id: star_import
    name: "Star Import"
    regex: "from\\s+\\S+\\s+import\\s+\\*"
    message: "Star import makes code harder to maintain - use explicit imports"
    skip_in_tests: true

  - id: none_comparison
    name: "None Comparison"
    regex: "==\\s*None"
    message: "Use 'is None' instead"
    skip_in_tests: true

  - id: print_statement
    name: "Print Statement"
    regex: "^\\s*print\\("
    message: "Consider using logging instead of print"
    skip_in_tests: true

  - id: bare_except
    name: "Bare Except"
    regex: "except:\\s*$"
    message: "Bare except catches all exceptions - specify exception types"
    skip_in_tests: true

  - id: todo_comment
    name: "TODO Comment"
    regex: "#\\s*TODO"
    flags: "i"
    message: "TODO found - consider creating a task"
    skip_in_tests: false

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ› BUGS - Silent bug patterns
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
bugs:
  - id: mutable_default
    name: "Mutable Default (B006)"
    regex: "def \\w+\\([^)]*=\\s*\\[\\]|def \\w+\\([^)]*=\\s*\\{\\}"
    message: "Mutable default shared between calls"
    level: "BLOCK"

  - id: assert_in_prod
    name: "Assert in Production"
    regex: "^\\s*assert\\s+(?!.*#.*test)"
    message: "assert is stripped with python -O"
    level: "WARN"
    skip_in_tests: true

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ—ï¸ ARCHITECTURE - DIP & import restrictions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
architecture:
  - id: dip_domain_infra
    name: "DIP Violation (Domain â†’ Infrastructure)"
    regex: "from backend\\.infrastructure"
    scope: ["backend/domain/**/*.py"]
    message: "Domain must not import Infrastructure (Dependency Inversion Principle)"
    level: "BLOCK"

  - id: dip_domain_application
    name: "DIP Violation (Domain â†’ Application)"
    regex: "from backend\\.application"
    scope: ["backend/domain/**/*.py"]
    message: "Domain must not import Application (Dependency Inversion Principle)"
    level: "BLOCK"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”§ MAINTAINABILITY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
maintainability:
  - id: print_debug
    name: "Print Debug"
    regex: "^\\s*print\\(.*debug|^\\s*print\\(f?[\"']\\s*(DEBUG|TODO|FIXME)"
    message: "Leftover debug print - use logging"
    level: "WARN"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ… EXCEPTIONS - Files where patterns are allowed
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
exceptions:
  test_files:
    patterns:
      - "test_*.py"
      - "*_test.py"
      - "tests/**/*.py"
    allowed:
      - "hardcoded_secret"
      - "sql_injection"
      - "command_injection"
      - "shell_injection"
      - "mutable_default"
    reason: "Tests can mock dangerous patterns for testing purposes"

  config_files:
    patterns:
      - "**/settings.py"
      - "**/config.py"
    allowed:
      - "star_import"
    reason: "Config files may use star imports for convenience"

# Complexity (enforced by scanner)
complexity:
  max_file_lines: 300    # WARN if file exceeds this (test files excluded)
  max_function_lines: 50 # For future use

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ¤– GUARDIAN - AI Coding Safety (Senior Mode)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
guardian:
  enabled: true              # Activate Guardian Mode
  auto_detect: true          # Auto-detect AI coding sessions
  warnings_as_blocking: false  # Escalate warnings to blocking in AI mode
  senior_mode: "auto"        # "off" | "auto" | "always"
                             # auto = run when AI session detected
                             # always = run on every scan

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ NOTES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# - Add custom patterns in blocking/warning sections
# - Use 'scope' to limit patterns to specific files
# - Use 'skip_in_tests' to ignore warnings in test files
# - Add exceptions for legitimate use cases
# - Architecture rules enforce DIP (domain cannot import infra/app)
# - Run: vibesrails --show to see all patterns
# - Run: vibesrails --validate to check config
# - Run: vibesrails --senior for manual Senior Mode
